<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="theke:/default.css" type="text/css">
        <link rel="stylesheet" href="theke:/bible.css" type="text/css">

        <title>{{ ref.bookName }} {{ ref.chapter }}</title>
    </head>
    <body>
        <h1>{{ ref.bookName }} {{ ref.chapter }}</h1>

        <bdi id="content" lang="{{ lang }}">
        {% for verse in verses %}
        <p  id="verse-{{ loop.index }}"><sup>{{ loop.index }}</sup>{{ verse }}</p>
        {% endfor %}
        </bdi>

        <script>
        var currentWord;
        var currentVerse;

        function jump_to_verse(verseTag) {
            var verse_to_scroll_to = document.getElementById(verseTag);

            if (verse_to_scroll_to != null) {
                // Unselect previous verse
                if (currentVerse != null) {
                    currentVerse.classList.remove("em");
                }

                // Select this verse
                currentVerse = verse_to_scroll_to;
                currentVerse.classList.add("em");

                currentVerse.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});
            }
        }

        function handle_click_on_word(evt) {
            word = evt.target.innerText;
            morph = evt.target.getAttribute("morph");
            lemma = evt.target.getAttribute("lemma");

            if ((morph != null) || (lemma != null)) {
                if (morph == null) { morph = ''; } else { morph = morph.replace(/\//g, '_'); }
                if (lemma == null) { lemma = ''; }

                // Unselect previous word
                if (currentWord != null) {
                    currentWord.classList.remove("selected");
                }
                
                // Select this word
                currentWord = evt.target;
                currentWord.classList.add("selected");

                // Send its morphology out of the webview
                r = "sword:/signal/click_on_word?word=" + word + "&morph=" + morph + "&lemma=" + lemma;
                fetch(r);
            }
        }

        document.getElementById("content").addEventListener('click', handle_click_on_word);
        </script>
    </body>
</html>